<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-AIËÅäÂ§©</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
        }
        #user-input {
            width: calc(100% - 70px);
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #send-button {
            width: 60px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .user-avatar {
            background-color: #4a90e2;
        }
        .assistant-avatar {
            background-color: #50c878;
        }
        .message-content {
            flex: 1;
        }
        .message a {
            color: #0066cc;
            text-decoration: none;
        }
        .message a:hover {
            text-decoration: underline;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 5px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-actions {
            display: flex;
            justify-content: flex-start;
            margin-top: 5px;
        }
        .message-actions button {
            margin-right: 5px;
            background-color: #f0f0f0;
            border: none;
            padding: 3px 8px;
            cursor: pointer;
            border-radius: 3px;
        }
        #stop-button {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            margin-right: 10px;
        }
        #input-container {
            display: flex;
            align-items: center;
        }
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .edit-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .edit-textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
        }
        .edit-buttons {
            display: flex;
            justify-content: flex-end;
        }
        .edit-buttons button {
            margin-left: 10px;
        }
        #history-container {
            padding: 10px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
            overflow-y: auto;
            max-height: 300px;
        }
        .history-group {
            margin-bottom: 10px;
        }
        .history-group h3 {
            margin: 0;
            padding: 5px 0;
            font-size: 14px;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            cursor: pointer;
        }
        .history-item:hover {
            background-color: #f0f0f0;
        }
        .delete-history {
            color: red;
            cursor: pointer;
        }
        #chat-area {
            flex: 1;
        }
        #author-info {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
        }
        #new-chat-button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }
        #delete-all-button {
            width: 40px;
            height: 40px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-left: auto;
        }
        #history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        @media (min-width: 768px) {
            #chat-container {
                flex-direction: row;
            }
            #history-container {
                width: 200px;
                border-top: none;
                border-right: 1px solid #ddd;
                max-height: none;
                height: 600px;
            }
            #chat-area {
                padding-left: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <div id="chat-container">
        <div id="chat-area">
            <h1>M-AIËÅäÂ§©</h1>
            <div id="chat-messages"></div>
            <div id="input-container">
                <button id="stop-button" style="display: none;" onclick="stopOutput()">ÂÅúÊ≠¢</button>
                <input type="text" id="user-input" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØ...">
                <button id="send-button">ÂèëÈÄÅ</button>
            </div>
        </div>
        <div id="history-container">
            <div id="history-controls">
                <button id="new-chat-button">Êñ∞Âª∫ËÅäÂ§©</button>
                <button id="delete-all-button">üóëÔ∏è</button>
            </div>
            <div id="history-list"></div>
        </div>
    </div>
    <div id="author-info">
        <a href="https://github.com/XCQ0607" target="_blank">‰ΩúËÄÖ Github</a>
    </div>

    <div id="edit-modal" class="edit-modal">
        <div class="edit-modal-content">
            <textarea id="edit-textarea" class="edit-textarea"></textarea>
            <div class="edit-buttons">
                <button onclick="saveEdit()">‰øùÂ≠ò</button>
                <button onclick="cancelEdit()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
    let mathJaxLoaded = false;
    let messageHistory = [];
    let controller = null;
    let currentEditingMessage = null;

    function loadMathJax() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
            script.async = true;
            script.onload = () => {
                mathJaxLoaded = true;
                resolve();
            };
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    loadMathJax().catch(error => {
        console.error('Failed to load MathJax:', error);
    });

    function getCurrentTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function encryptstring(input, key = "mimouse_sign_2019_1_16_13_23") {
        const encoder = new TextEncoder();
        const keyBytes = encoder.encode(key);
        let encryptedstring = "";
        for (let i = 0; i < input.length; i++) {
            const inputChar = input.charCodeAt(i);
            const keyByte = keyBytes[i % keyBytes.length];
            const encryptedchar = String.fromCharCode(inputChar ^ keyByte);
            encryptedstring += encryptedchar;
        }
        return encryptedstring;
    }

    function formatMessage(content) {
        content = content.replace(/\$([^$]+)\]\$([^)]+)\$/g, '<a href="\$2" target="_blank">\$1</a>');
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>\$1</strong>');
        content = content.replace(/\*(.*?)\*/g, '<em>\$1</em>');
        content = content.replace(/`([^`]+)`/g, '<code>\$1</code>');
        content = content.replace(/\$\$(.*?)\$\$/g, '\\[\$1\\]');
        content = content.replace(/\$(.*?)\$/g, '\$\$1\$');
        content = content.replace(/\n/g, '<br>');
        return content;
    }

    function renderMathAndCode(element) {
        if (mathJaxLoaded && window.MathJax) {
            MathJax.typesetPromise([element]).then(() => {
                hljs.highlightAll();
            });
        } else {
            hljs.highlightAll();
        }
    }

    async function sendMessage() {
        const userInput = document.getElementById('user-input');
        const message = userInput.value.trim();
        if (message === '') return;

        addMessage('user', message);
        userInput.value = '';

        messageHistory.push({ role: "user", content: message });

        const timestamp = getCurrentTime();
        const data = {
            "userId": "",
            "timestamp": timestamp,
            "appkey": "6EC91F3C7DB58EF58C97742EF4268E66",
            "sncode": "",
            "version": "2.0.1.5",
            "stream": true,
            "messages": messageHistory,
            "sign": btoa(encryptstring(JSON.stringify({
                "userId": "",
                "timestamp": timestamp,
                "appkey": "6EC91F3C7DB58EF58C97742EF4268E66",
                "sncode": "",
                "version": "2.0.1.5"
            }))),
            "custom": 0,
            "websearch": false,
            "ai_mode": "creative",
            "model": 0
        };

        document.getElementById('stop-button').style.display = 'inline-block';

        controller = new AbortController();
        const signal = controller.signal;

        try {
            const response = await fetch('https://nocos.chinax.site/https://chat.mimouse.com/api/v2/mimousechat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Referer': 'https://www.mimouse.com/'
                },
                body: JSON.stringify(data),
                signal: signal
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let assistantMessage = '';
            const messageElement = addMessage('assistant', '');

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                assistantMessage += chunk;
                messageElement.querySelector('.message-content').innerHTML = formatMessage(assistantMessage);
                renderMathAndCode(messageElement);
            }

            messageHistory.push({ role: "assistant", content: assistantMessage });
            saveChat(messageHistory);

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Fetch aborted');
            } else {
                console.error('Error:', error);
                addMessage('assistant', 'ÂèëÁîüÈîôËØØÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
            }
        } finally {
            document.getElementById('stop-button').style.display = 'none';
        }
    }

    function stopOutput() {
        if (controller) {
            controller.abort();
            controller = null;
        }
    }

    function addMessage(role, content) {
        const chatMessages = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${role}-message`);
        
        const avatar = document.createElement('div');
        avatar.classList.add('avatar', `${role}-avatar`);
        avatar.textContent = role === 'user' ? 'USER' : 'GPT';
        
        const messageContent = document.createElement('div');
        messageContent.classList.add('message-content');
        messageContent.innerHTML = formatMessage(content);
        
        const spinner = document.createElement('div');
        spinner.classList.add('spinner');
        
        messageElement.appendChild(avatar);
        messageElement.appendChild(messageContent);
        
        if (role === 'assistant') {
            messageContent.appendChild(spinner);
        }
        
        const messageActions = document.createElement('div');
        messageActions.classList.add('message-actions');
        
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Âà†Èô§';
        deleteButton.onclick = () => {
            messageElement.remove();
            const index = messageHistory.findIndex(msg => msg.content === content);
            if (index !== -1) {
                messageHistory.splice(index, 1);
            }
        };
        
        const copyButton = document.createElement('button');
        copyButton.textContent = 'Â§çÂà∂';
        copyButton.onclick = () => {
            navigator.clipboard.writeText(messageContent.textContent).then(() => {
                alert('Ê∂àÊÅØÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            });
        };
        
        const editButton = document.createElement('button');
        editButton.textContent = '‰øÆÊîπ';
        editButton.onclick = () => {
            currentEditingMessage = messageElement;
            document.getElementById('edit-textarea').value = messageContent.textContent;
            document.getElementById('edit-modal').style.display = 'block';
        };
        
        messageActions.appendChild(deleteButton);
        messageActions.appendChild(copyButton);
        messageActions.appendChild(editButton);
        
        messageElement.appendChild(messageContent);
        messageElement.appendChild(messageActions);
        
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        renderMathAndCode(messageElement);
        
        return messageElement;
    }

    function saveEdit() {
        const newContent = document.getElementById('edit-textarea').value;
        if (currentEditingMessage) {
            const messageContent = currentEditingMessage.querySelector('.message-content');
            messageContent.innerHTML = formatMessage(newContent);
            renderMathAndCode(currentEditingMessage);

            // Êõ¥Êñ∞Ê∂àÊÅØÂéÜÂè≤
            const index = messageHistory.findIndex(msg => msg.content === messageContent.textContent);
            if (index !== -1) {
                messageHistory[index].content = newContent;
            }
        }
        document.getElementById('edit-modal').style.display = 'none';
    }

    function cancelEdit() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    function saveChat(messages) {
        const chatId = Date.now();
        const chat = {
            id: chatId,
            date: new Date().toISOString().split('T')[0],
            messages: messages
        };
        let chats = JSON.parse(localStorage.getItem('chats') || '[]');
        chats.unshift(chat);
        localStorage.setItem('chats', JSON.stringify(chats));
        updateHistoryList();
    }

    function updateHistoryList() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        const chats = JSON.parse(localStorage.getItem('chats') || '[]');
        const groupedChats = groupChatsByDate(chats);

        for (const [date, dateChats] of Object.entries(groupedChats)) {
            const groupElement = document.createElement('div');
            groupElement.className = 'history-group';
            groupElement.innerHTML = `<h3>${formatDate(date)}</h3>`;

            dateChats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = 'history-item';
                chatElement.innerHTML = `
                    <span onclick="loadChat(${chat.id})">${chat.messages[0].content.substring(0, 20)}...</span>
                    <span class="delete-history" onclick="deleteChat(${chat.id})">Âà†Èô§</span>
                `;
                groupElement.appendChild(chatElement);
            });

            historyList.appendChild(groupElement);
        }
    }

    function groupChatsByDate(chats) {
        const grouped = {};
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const twoDaysAgo = new Date(Date.now() - 172800000).toISOString().split('T')[0];

        chats.forEach(chat => {
            let key;
            if (chat.date === today) key = '‰ªäÂ§©';
            else if (chat.date === yesterday) key = 'Êò®Â§©';
            else if (chat.date === twoDaysAgo) key = 'ÂâçÂ§©';
            else key = chat.date;

            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(chat);
        });

        return grouped;
    }

    function formatDate(date) {
        if (['‰ªäÂ§©', 'Êò®Â§©', 'ÂâçÂ§©'].includes(date)) return date;
        return date; // Â¶ÇÊûúÈúÄË¶ÅÔºåËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êõ¥Â§öÁöÑÊó•ÊúüÊ†ºÂºèÂåñÈÄªËæë
    }

    function loadChat(chatId) {
        const chats = JSON.parse(localStorage.getItem('chats') || '[]');
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            messageHistory = chat.messages;
            document.getElementById('chat-messages').innerHTML = '';
            messageHistory.forEach(msg => addMessage(msg.role, msg.content));
        }
    }

    function deleteChat(chatId) {
        let chats = JSON.parse(localStorage.getItem('chats') || '[]');
        chats = chats.filter(c => c.id !== chatId);
        localStorage.setItem('chats', JSON.stringify(chats));
        updateHistoryList();
    }

    function newChat() {
        messageHistory = [];
        document.getElementById('chat-messages').innerHTML = '';
    }

    function deleteAllChats() {
        if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü')) {
            localStorage.removeItem('chats');
            updateHistoryList();
        }
    }

    document.getElementById('send-button').addEventListener('click', sendMessage);
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    document.getElementById('new-chat-button').addEventListener('click', newChat);
    document.getElementById('delete-all-button').addEventListener('click', deleteAllChats);

    // È°µÈù¢Âä†ËΩΩÊó∂Êõ¥Êñ∞ÂéÜÂè≤ÂàóË°®
    window.addEventListener('load', updateHistoryList);
    </script>
</body>
</html>
