<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPFS文件上传器</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f0f0;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
    }
    #dropZone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #dropZone:hover, #dropZone.dragover {
      background-color: #e9e9e9;
    }
    #fileInput {
      display: none;
    }
    #uploadButton {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    #uploadButton:hover {
      background-color: #45a049;
    }
    #uploadButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #progressContainer {
      margin-top: 20px;
      position: relative;
    }
    #progressBar {
      width: 0;
      height: 20px;
      background-color: #4CAF50;
      border-radius: 10px;
      transition: width 0.3s;
    }
    #progressText {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      text-align: center;
      line-height: 20px;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    #uploadHistory {
      margin-top: 20px;
    }
    .historyItem {
      background-color: #f9f9f9;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      animation: fadeIn 0.5s;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .historyItem:hover {
      background-color: #e9e9e9;
    }
    .contextMenu {
      display: none;
      position: absolute;
      background-color: #ffffff;
      border: 1px solid #cccccc;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .contextMenu ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .contextMenu li {
      padding: 8px 12px;
      cursor: pointer;
    }
    .contextMenu li:hover {
      background-color: #f0f0f0;
    }
    #propertiesModal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: #fefefe;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #propertiesModal .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    #propertiesModal .close:hover,
    #propertiesModal .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    #fileList {
      margin-top: 10px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    footer {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>IPFS文件上传器</h1>
    <div id="dropZone">
      <p>拖放文件/文件夹到这里或点击选择</p>
      <input type="file" id="fileInput" webkitdirectory multiple>
    </div>
    <div id="fileList"></div>
    <button id="uploadButton" disabled>上传</button>
    <div id="progressContainer">
      <div id="progressBar"></div>
      <div id="progressText">0% (0 B / 0 B)</div>
    </div>
    <div id="uploadHistory"></div>
  </div>

  <div id="contextMenu" class="contextMenu">
    <ul>
      <li id="downloadFile">下载</li>
      <li id="showProperties">属性</li>
      <li id="deleteRecord">删除记录</li>
    </ul>
  </div>

  <div id="propertiesModal">
    <span class="close">&times;</span>
    <h2>文件属性</h2>
    <div id="propertiesContent"></div>
  </div>

  <footer>
    <p>作者 GitHub: <a href="https://github.com/XCQ0607" target="_blank">https://github.com/XCQ0607</a></p>
  </footer>

  <script>
    const api = 'https://gw.crustfiles.net/api/v0/add?pin=true&chunker=size-1048576&hash=blake2b-256&raw-leaves=true&slient=true';
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const uploadHistory = document.getElementById('uploadHistory');
    const contextMenu = document.getElementById('contextMenu');
    const propertiesModal = document.getElementById('propertiesModal');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];

    // 从本地存储加载上传历史
    let history = JSON.parse(localStorage.getItem('uploadHistory')) || [];

    function updateHistory() {
      uploadHistory.innerHTML = '';
      history.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'historyItem';
        historyItem.innerHTML = `
          <span>${item.name}</span>
          <span>${formatSize(item.size)}</span>
        `;
        historyItem.addEventListener('contextmenu', (e) => showContextMenu(e, index));
        uploadHistory.appendChild(historyItem);
      });
    }

    updateHistory();

    function formatSize(bytes) {
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      if (bytes === 0) return '0 B';
      const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
      return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
    }

    function showContextMenu(e, index) {
      e.preventDefault();
      contextMenu.style.display = 'block';
      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;

      document.getElementById('downloadFile').onclick = () => downloadFile(index);
      document.getElementById('showProperties').onclick = () => showProperties(index);
      document.getElementById('deleteRecord').onclick = () => deleteRecord(index);
    }

    document.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });

    function downloadFile(index) {
      const item = history[index];
      window.open(`https://${item.hash}.ipfs.gateway.v2ex.pro/`);
    }

    function showProperties(index) {
      const item = history[index];
      const content = `
        <p><strong>名称:</strong> ${item.name}</p>
        <p><strong>日期:</strong> ${item.date}</p>
        <p><strong>大小:</strong> ${formatSize(item.size)}</p>
        <p><strong>CID:</strong> ${item.hash}</p>
      `;
      document.getElementById('propertiesContent').innerHTML = content;
      propertiesModal.style.display = 'block';
    }

    function deleteRecord(index) {
      history.splice(index, 1);
      localStorage.setItem('uploadHistory', JSON.stringify(history));
      updateHistory();
    }

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      selectedFiles = e.dataTransfer.files;
      updateFileList();
      uploadButton.disabled = false;
    });

    fileInput.addEventListener('change', () => {
      selectedFiles = fileInput.files;
      updateFileList();
      uploadButton.disabled = false;
    });

    function updateFileList() {
      fileList.innerHTML = '';
      for (let file of selectedFiles) {
        fileList.innerHTML += `<div>${file.name} (${formatSize(file.size)})</div>`;
      }
    }

    uploadButton.addEventListener('click', uploadFiles);

    function uploadFiles() {
      uploadButton.disabled = true;
      progressBar.style.width = '0%';
      progressText.textContent = '0% (0 B / 0 B)';

      let body = new FormData();
      let totalSize = 0;
      let uploadedSize = 0;

      for (let file of selectedFiles) {
        body.append("file", file);
        totalSize += file.size;
      }

      if (totalSize > 698 * 1024 * 1024) {
        alert("上传的文件总大小不能超过698.0 MiB");
        uploadButton.disabled = false;
        return;
      }

      let xhr = new XMLHttpRequest();
      xhr.upload.onprogress = (e) => {
        uploadedSize = e.loaded;
        const percentage = Math.round((uploadedSize / totalSize) * 100);
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}% (${formatSize(uploadedSize)} / ${formatSize(totalSize)})`;
      };

      xhr.onerror = () => {
        alert("网络错误");
        uploadButton.disabled = false;
      };

      xhr.onload = () => {
        const response = JSON.parse(xhr.responseText);
        const newItem = {
          name: selectedFiles[0].name,
          hash: response.Hash,
          date: new Date().toLocaleString(),
          size: totalSize,
        };
        history.unshift(newItem);
        localStorage.setItem('uploadHistory', JSON.stringify(history));
        updateHistory();
        uploadButton.disabled = false;
        fileList.innerHTML = '';
      };

      xhr.open("POST", api);
      xhr.setRequestHeader("authorization", "Basic ZXRoLTB4YzRiZjFkMjhlYmM4NzdlNmUyMjc3YTJjZDljOTFlYmU5MTc4MTRiYjoweGQ0YzBkMWQ1ZTQ4MTYzY2RlMWFlMjkxNjI1MGI5MDYxYmQ0OGRiNWJlNjViOWE0NTc1MzJmZmI3ZWI4YjY2ZjI0NGUwMjc0MmUzYzg1ZTNlNzY0NzBiYWNkMzgzMDE5NjkwZDdlMDM0ZjFjN2Y4NzBlMGI1YmU4MDNmMDZhMzQ3MWM=");
      xhr.send(body);
    }

    // 关闭属性模态框
    document.querySelector('.close').onclick = function() {
      propertiesModal.style.display = "none";
    }

    window.onclick = function(event) {
      if (event.target == propertiesModal) {
        propertiesModal.style.display = "none";
      }
    }
  </script>
</body>
</html>